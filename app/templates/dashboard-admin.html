<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | Chikitsa Smart</title>
    <link rel="icon" href="{{ url_for('static', filename='images/chikitsa-smart-logo.png') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
        integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>

<body>
    <header class="header">
        <a href="{{ url_for('index') }}" class="logo brand"><img src="{{ url_for('static', filename='images/chikitsa-smart-logo.png') }}" alt="Chikitsa Smart logo"><span>Chikitsa Smart</span></a>
        <nav class="navbar">
            <a href="{{ url_for('index') }}">Home</a>
            <a href="{{ url_for('dashboard') }}">Dashboard</a>
            <a href="{{ url_for('helpdesk') }}">AI Helpdesk</a>
            <a href="{{ url_for('notifications') }}">Notifications</a>
            <a href="{{ url_for('logout') }}">Logout</a>
        </nav>
    </header>

    <section class="dashboard">
        <h1 class="heading">Admin <span>Dashboard</span></h1>
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        {% for category, message in messages %}
        <center>
            <p style="color: white; font-size: 1.5rem;" class="alert alert-{{ category }}">{{ message }}</p>
        </center>
        {% endfor %}
        {% endif %}
        {% endwith %}

        <div class="card-grid">
            <div class="card">
                <h3>Total Patients</h3>
                <p>{{ total_patients }}</p>
            </div>
            <div class="card">
                <h3>Total Doctors</h3>
                <p>{{ total_doctors }}</p>
            </div>
            <div class="card">
                <h3>Today Appointments</h3>
                <p>{{ today_appointments }}</p>
            </div>
            <div class="card">
                <h3>Emergency Cases</h3>
                <p>{{ emergency_count }}</p>
            </div>
        </div>

        <div class="card-grid">
            <div class="card">
                <h3>Queue Load</h3>
                <p id="crowd-level">{{ crowd_status.level }}</p>
                <p id="crowd-details">Queue: {{ crowd_status.queue_len }} | Available Doctors: {{ crowd_status.available_doctors }}</p>
            </div>
            <div class="card">
                <h3>Active Queue</h3>
                <p>{{ waiting }}</p>
            </div>
        </div>

        <div class="card">
            <h3>Doctor Availability Control</h3>
            <table class="table">
                <thead>
                    <tr>
                        <th>Doctor</th>
                        <th>Specialization</th>
                        <th>Status</th>
                        <th>Update</th>
                    </tr>
                </thead>
                <tbody>
                    {% for doctor in doctors %}
                    <tr>
                        <td>{{ doctor.full_name or doctor.username }}</td>
                        <td>{{ doctor.type_of_doctor or 'General' }}</td>
                        <td>{{ doctor.availability_status }}</td>
                        <td>
                            <form action="{{ url_for('admin_update_availability', doctor_id=doctor.id) }}" method="post" class="form-inline">
                                <select name="status">
                                    <option value="Available" {% if doctor.availability_status == 'Available' %}selected{% endif %}>Available</option>
                                    <option value="On Break" {% if doctor.availability_status == 'On Break' %}selected{% endif %}>On Break</option>
                                    <option value="Off Duty" {% if doctor.availability_status == 'Off Duty' %}selected{% endif %}>Off Duty</option>
                                </select>
                                <input type="text" name="note" placeholder="Note" value="{{ doctor.availability_note or '' }}">
                                <input type="submit" value="Update" class="btn">
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="card" style="margin-top: 2rem;">
            <h3>Emergency Queue</h3>
            <table class="table">
                <thead>
                    <tr>
                        <th>Token</th>
                        <th>Patient</th>
                        <th>Doctor</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for entry in emergency_cases %}
                    <tr>
                        <td>{{ entry.token_number }}</td>
                        <td>{{ entry.patient.full_name or entry.patient.username }}</td>
                        <td>{{ entry.doctor.full_name or entry.doctor.username }}</td>
                        <td>{{ entry.status }}</td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="4">No emergency cases right now.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </section>

    <script>
        async function refreshCrowd() {
            try {
                const res = await fetch('{{ url_for('api_crowd_status') }}');
                if (!res.ok) return;
                const data = await res.json();
                document.getElementById('crowd-level').textContent = data.level;
                document.getElementById('crowd-details').textContent = `Queue: ${data.queue_len} | Available Doctors: ${data.available_doctors}`;
            } catch (err) {
                console.error(err);
            }
        }

        setInterval(refreshCrowd, 8000);
    </script>
    <script src="{{ url_for('static', filename='js/script.js') }}"></script>
</body>

</html>
