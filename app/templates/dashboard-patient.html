<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Dashboard | Chikitsa Smart</title>
    <link rel="icon" href="{{ url_for('static', filename='images/chikitsa-smart-logo.png') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
        integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>

<body>
    <header class="header">
        <a href="{{ url_for('index') }}" class="logo brand"><img src="{{ url_for('static', filename='images/chikitsa-smart-logo.png') }}" alt="Chikitsa Smart logo"><span>Chikitsa Smart</span></a>
        <nav class="navbar">
            <a href="{{ url_for('index') }}">Home</a>
            <a href="{{ url_for('dashboard') }}">Dashboard</a>
            <a href="{{ url_for('book_appointment') }}">Book Appointment</a>
            <a href="{{ url_for('helpdesk') }}">AI Helpdesk</a>
            <a href="{{ url_for('notifications') }}">Notifications</a>
            <a href="{{ url_for('logout') }}">Logout</a>
        </nav>
    </header>

    <section class="dashboard">
        <h1 class="heading">Patient <span>Dashboard</span></h1>

        <div class="card-grid">
            <div class="card">
                <h3>Welcome</h3>
                <p>{{ user.full_name or user.username }}</p>
                <p>Language: {{ user.language or 'en' }}</p>
            </div>
            <div class="card">
                <h3>Current Token</h3>
                <p id="token-number">{{ appointment.token_number if appointment else 'N/A' }}</p>
            </div>
            <div class="card">
                <h3>Queue Position</h3>
                <p id="queue-position">{{ queue_position or 'N/A' }}</p>
            </div>
            <div class="card">
                <h3>Estimated Wait</h3>
                <p id="wait-minutes">{{ wait_minutes or 'N/A' }} minutes</p>
            </div>
            <div class="card">
                <h3>Crowd Monitor</h3>
                <p>Level: {{ crowd_status.level }}</p>
                <p>Queue: {{ crowd_status.queue_len }} | Doctors: {{ crowd_status.available_doctors }}</p>
            </div>
        </div>

        <div class="card">
            <h3>Appointment Details</h3>
            {% if appointment %}
            <p>Doctor: {{ appointment.doctor.full_name or appointment.doctor.username }}</p>
            <p>Priority: {{ appointment.priority_level }}</p>
            <p>Status: {{ appointment.status }}</p>
            <p>Scheduled Time: {{ appointment.scheduled_time.strftime('%Y-%m-%d %H:%M') }}</p>
            {% else %}
            <p>No appointment booked yet.</p>
            <a href="{{ url_for('book_appointment') }}" class="btn">Book Now</a>
            {% endif %}
        </div>
    </section>

    <script>
        async function refreshPatientStatus() {
            try {
                const res = await fetch('{{ url_for('api_patient_status') }}');
                if (!res.ok) return;
                const data = await res.json();
                if (data.status === 'no_appointment') return;
                document.getElementById('token-number').textContent = data.token;
                document.getElementById('queue-position').textContent = data.position;
                document.getElementById('wait-minutes').textContent = `${data.wait_minutes} minutes`;
            } catch (err) {
                console.error(err);
            }
        }

        setInterval(refreshPatientStatus, 8000);
    </script>
    <script src="{{ url_for('static', filename='js/script.js') }}"></script>
</body>

</html>
